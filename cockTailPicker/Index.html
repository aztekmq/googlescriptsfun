<!DOCTYPE html>
<!--
  @fileoverview Front-end interface for the Mythic Mixology Lab. Provides
  age verification, generator selection, search catalogue, and vote handling
  with verbose logging for collaborative international teams.
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#0071e3" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest.json" id="pwaManifestLink" />
    <link rel="apple-touch-icon" id="appleTouchIconLink" />
    <script src="assets/icon-assets.js"></script>
    <title>Mythic Mixology Lab</title>
    <style>
      :root {
        color-scheme: light;
        font-family: 'Poppins', 'Segoe UI', Roboto, sans-serif;
        --bg-gradient: linear-gradient(135deg, #f5f5f7, #d2d2d7 45%, #e5e5ea);
        --accent-gradient: linear-gradient(135deg, #0a84ff, #0071e3);
        --accent-solid: #0071e3;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-border: rgba(0, 0, 0, 0.08);
        --text-primary: #1d1d1f;
        --text-muted: rgba(29, 29, 31, 0.6);
        --danger: #ff3b30;
        --success: #34c759;
        --surface-elevated: rgba(255, 255, 255, 0.85);
        --shadow-soft: 0 24px 48px rgba(41, 41, 43, 0.18);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        min-height: 100dvh;
        background: var(--bg-gradient);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(16px, 4vw, 56px);
        position: relative;
        -webkit-tap-highlight-color: transparent;
      }

      h1,
      h2,
      h3 {
        font-weight: 600;
        margin: 0;
      }

      p {
        margin: 0;
        color: var(--text-muted);
      }

      button,
      .button-link {
        cursor: pointer;
        border: none;
        padding: 14px 24px;
        border-radius: 999px;
        background: var(--accent-gradient);
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.02em;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        box-shadow: 0 12px 24px rgba(0, 113, 227, 0.22);
      }

      button:hover,
      .button-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(0, 113, 227, 0.28);
      }

      button:disabled {
        opacity: 0.5;
        cursor: wait;
        transform: none;
        box-shadow: none;
      }

      .app-shell {
        width: min(1080px, 100%);
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 28px;
        padding: clamp(24px, 3vw, 40px);
        box-shadow: var(--shadow-soft);
        display: none;
        position: relative;
        backdrop-filter: blur(12px);
        margin: 0 auto;
      }

      .app-shell.active {
        display: block;
      }

      .top-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: clamp(16px, 3vw, 28px);
        gap: 16px;
      }

      .home-button {
        background: rgba(255, 255, 255, 0.65);
        color: var(--text-primary);
        border-radius: 999px;
        padding: 10px 18px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(12px);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .home-button:hover {
        background: rgba(255, 255, 255, 0.85);
      }

      .view {
        display: none;
        animation: fadeIn 0.4s ease;
      }

      .view.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hero-card {
        background: var(--surface-elevated);
        border-radius: 24px;
        padding: clamp(28px, 4vw, 42px);
        border: 1px solid var(--card-border);
        text-align: center;
        box-shadow: 0 20px 38px rgba(41, 41, 43, 0.12);
      }

      .hero-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
        margin-top: 28px;
      }

      form {
        display: grid;
        gap: 18px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-primary);
      }

      select,
      input,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        font-size: 0.97rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(10, 132, 255, 0.85);
        box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
      }

      .field-invalid {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.3) !important;
      }

      .form-grid {
        display: grid;
        gap: 18px;
      }

      @media (min-width: 720px) {
        .form-grid.two-column {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .result-card {
        margin-top: 28px;
        padding: 24px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid rgba(0, 0, 0, 0.05);
        display: none;
      }

      .result-card.active {
        display: block;
      }

      .result-card h2 {
        font-size: 1.8rem;
        margin-bottom: 12px;
      }

      .result-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 16px;
        color: var(--success);
        font-weight: 600;
      }

      ul.styled-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }

      ul.styled-list li::before {
        content: '\2022';
        margin-right: 10px;
        color: var(--accent-solid);
      }

      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.15);
        display: none;
        min-width: 280px;
        z-index: 50;
      }

      .toast.active {
        display: block;
      }

      .search-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 18px;
      }

      .search-controls input {
        flex: 1;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.78);
        border-radius: 16px;
        overflow: hidden;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table-container table {
        min-width: 640px;
      }

      thead {
        background: rgba(242, 242, 247, 0.75);
      }

      th,
      td {
        padding: 14px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      th button {
        background: none;
        color: inherit;
        padding: 0;
        font: inherit;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .table-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .ghost-button {
        background: rgba(10, 132, 255, 0.1);
        color: var(--accent-solid);
        border: 1px solid rgba(10, 132, 255, 0.25);
        padding: 10px 16px;
      }

      .detail-overlay {
        position: fixed;
        inset: 0;
        background: rgba(245, 245, 247, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 20;
      }

      .detail-overlay.active {
        display: flex;
      }

      .detail-card {
        width: min(520px, 100%);
        background: rgba(255, 255, 255, 0.96);
        border-radius: 24px;
        padding: 28px;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      .age-gate {
        position: fixed;
        inset: 0;
        background: rgba(245, 245, 247, 0.92);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 30;
        padding: clamp(24px, 6vw, 48px);
      }

      .age-card {
        background: rgba(255, 255, 255, 0.96);
        padding: clamp(28px, 5vw, 40px);
        border-radius: 28px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        width: min(460px, 100%);
        text-align: center;
        box-shadow: 0 26px 60px rgba(41, 41, 43, 0.16);
      }

      .age-card h2 {
        margin-bottom: 12px;
      }

      .age-card form {
        margin-top: 24px;
        display: grid;
        gap: 18px;
      }

      .age-error {
        color: var(--danger);
        margin-top: 12px;
        display: none;
      }

      .age-error.active {
        display: block;
      }

      .choice-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .choice-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        border-radius: 20px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.92);
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      .choice-option input[type='radio'] {
        width: 20px;
        height: 20px;
        accent-color: var(--accent-solid);
      }

      .choice-option:hover {
        border-color: rgba(10, 132, 255, 0.6);
        box-shadow: 0 10px 24px rgba(10, 132, 255, 0.12);
      }

      .status-text {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .install-banner {
        position: fixed;
        inset-inline: 16px;
        bottom: 16px;
        padding: 18px 20px;
        background: rgba(255, 255, 255, 0.94);
        border-radius: 20px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.18);
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        z-index: 60;
      }

      .install-banner[hidden] {
        display: none;
      }

      .install-banner__text {
        flex: 1;
      }

      .install-banner__title {
        margin: 0 0 6px;
        font-size: 1.05rem;
      }

      .install-banner__actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .install-banner--ios {
        flex-direction: column;
        text-align: left;
      }

      .install-banner--ios .install-banner__actions {
        width: 100%;
        justify-content: flex-end;
      }

      @media (max-width: 720px) {
        body {
          padding: clamp(16px, 6vw, 36px);
        }

        .top-nav {
          flex-direction: column;
          align-items: flex-start;
        }

        .hero-actions {
          flex-direction: column;
          width: 100%;
        }

        .hero-actions button,
        .hero-actions .ghost-button {
          width: 100%;
          justify-content: center;
        }

        .search-controls {
          flex-direction: column;
        }

        .toast {
          left: 16px;
          right: 16px;
          bottom: 16px;
          min-width: auto;
        }

        .table-container table {
          min-width: 100%;
        }

        .install-banner {
          flex-direction: column;
          gap: 12px;
          align-items: flex-start;
        }

        .install-banner__actions {
          width: 100%;
          justify-content: space-between;
        }
      }

      @media (max-width: 480px) {
        h1 {
          font-size: clamp(1.8rem, 6vw, 2.4rem);
        }

        h2 {
          font-size: clamp(1.3rem, 5vw, 1.8rem);
        }

        button,
        .button-link {
          width: 100%;
          justify-content: center;
        }

        .home-button {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <section class="age-gate" id="ageGate" role="dialog" aria-modal="true">
      <div class="age-card">
        <h2>Age Verification</h2>
        <p>Please confirm that you are 21 years of age or older to enter the Mythic Mixology Lab.</p>
        <form id="ageForm" autocomplete="off">
          <fieldset class="choice-group" role="radiogroup" aria-labelledby="ageQuestion">
            <legend id="ageQuestion" style="position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0 0 0 0);">
              Are you 21 years old or older?
            </legend>
            <label class="choice-option" for="ageYes">
              <input id="ageYes" name="ageConfirmation" type="radio" value="yes" required aria-required="true" />
              <span>Yes, I am 21 or older.</span>
            </label>
            <label class="choice-option" for="ageNo">
              <input id="ageNo" name="ageConfirmation" type="radio" value="no" />
              <span>No, I am under 21.</span>
            </label>
          </fieldset>
          <button type="submit" style="margin-top: 6px">Continue</button>
          <div class="age-error" id="ageError">Please confirm that you are 21 or older to continue.</div>
        </form>
      </div>
    </section>

    <main class="app-shell" id="appShell" aria-live="polite">
      <header class="top-nav">
        <button class="home-button" id="homeButton" type="button" aria-label="Return to main home page">
          <span>⟵</span>
          <span>Main Constellation</span>
        </button>
        <div>
          <span class="status-text" id="userSignature"></span>
        </div>
      </header>

      <section class="view active" id="homeView">
        <div class="hero-card">
          <h1>Mythic Mixology Lab</h1>
          <p>
            Choose your destiny: conjure new cosmic cocktails or explore the catalog of community creations.
            Every action is logged with verbose precision for our global team.
          </p>
          <div class="hero-actions">
            <button id="newDrinkButton" type="button">Create New Drinks</button>
            <button id="searchButton" type="button" class="ghost-button">Search Existing</button>
          </div>
        </div>
      </section>

      <section class="view" id="createView" aria-labelledby="createHeading">
        <h2 id="createHeading">Create a Destiny Drink</h2>
        <p style="margin-bottom: 18px">Complete the fields below and let fate infuse your glass.</p>
        <form id="createForm">
          <div>
            <label for="generatorKey">Choose your generator</label>
            <select id="generatorKey" name="generatorKey" required>
              <option value="">Select a celestial engine</option>
              <option value="astro">Astrological Elixir Generator</option>
              <option value="numerology">Name Numerology Mixer</option>
              <option value="chrono">Birthday Chrono-Cocktail</option>
              <option value="oracle">Personalized Palate Oracle</option>
              <option value="dynasty">Dynastic Drink Dynasty</option>
            </select>
          </div>
          <div class="form-grid two-column">
            <div>
              <label for="birthMonth">Birth month</label>
              <select id="birthMonth" name="birthMonth" required></select>
            </div>
            <div>
              <label for="birthDay">Birth day</label>
              <input id="birthDay" name="birthDay" type="number" min="1" max="31" required />
            </div>
          </div>
          <div class="form-grid two-column">
            <div>
              <label for="firstName">First name</label>
              <input id="firstName" name="firstName" type="text" required />
            </div>
            <div>
              <label for="lastName">Last name</label>
              <input id="lastName" name="lastName" type="text" required />
            </div>
          </div>
          <button type="submit" id="generateButton">Generate</button>
        </form>

        <article class="result-card" id="resultCard">
          <h2 id="resultName"></h2>
          <div class="result-meta" id="resultMeta"></div>
          <p id="resultReason" style="margin-bottom: 18px"></p>
          <h3>Ingredients</h3>
          <ul class="styled-list" id="resultIngredients"></ul>
          <h3 style="margin-top: 20px">Instructions</h3>
          <ul class="styled-list" id="resultInstructions"></ul>
        </article>
      </section>

      <section class="view" id="searchView" aria-labelledby="searchHeading">
        <h2 id="searchHeading">Explore the Archive</h2>
        <p style="margin-bottom: 20px">Filter, sort, vote, and dive into detailed notes from every generated beverage.</p>
        <div class="search-controls">
          <input id="searchInput" type="search" placeholder="Filter by drink name, generator, or reason" />
          <button id="refreshButton" type="button" class="ghost-button">Refresh Archive</button>
        </div>
        <div class="table-container">
          <table aria-live="polite">
            <thead>
              <tr>
                <th><button type="button" data-sort="drinkName">Drink</button></th>
                <th><button type="button" data-sort="generatorLabel">Generator</button></th>
                <th><button type="button" data-sort="compatibility">Alignment</button></th>
                <th><button type="button" data-sort="voteCount">Votes</button></th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="drinksTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <section class="detail-overlay" id="detailOverlay" role="dialog" aria-modal="true">
      <div class="detail-card">
        <h2 id="detailName"></h2>
        <p id="detailMeta" style="margin: 12px 0"></p>
        <p id="detailReason" style="margin-bottom: 16px"></p>
        <h3>Ingredients</h3>
        <ul class="styled-list" id="detailIngredients"></ul>
        <h3 style="margin-top: 18px">Instructions</h3>
        <ul class="styled-list" id="detailInstructions"></ul>
        <button type="button" class="ghost-button" id="closeDetailButton" style="margin-top: 20px">Close</button>
      </div>
    </section>

    <div class="toast" id="toast" role="status"></div>

    <aside class="install-banner" id="installBanner" hidden role="region" aria-live="polite">
      <div class="install-banner__text">
        <h3 class="install-banner__title">Install Mythic Mixology Lab</h3>
        <p>Save this experience to your home screen for a native-feeling adventure.</p>
      </div>
      <div class="install-banner__actions">
        <button type="button" class="ghost-button" id="installDismissButton">Maybe later</button>
        <button type="button" id="installButton">Install App</button>
      </div>
    </aside>

    <aside
      class="install-banner install-banner--ios"
      id="iosInstallBanner"
      hidden
      role="region"
      aria-live="polite"
    >
      <div class="install-banner__text">
        <h3 class="install-banner__title">Add Mythic Mixology Lab</h3>
        <p>
          Tap the share icon in Safari and choose <strong>Add to Home Screen</strong> to enjoy the full-screen
          experience.
        </p>
      </div>
      <div class="install-banner__actions">
        <button type="button" class="ghost-button" id="iosDismissButton">Understood</button>
      </div>
    </aside>

    <script>
      /**
       * @fileoverview Client-side controller for view management, validation,
       * Apps Script communication, and dynamic rendering with verbose logging.
       */
      (function () {
        /** @type {{isVerified: boolean, birthYear: number|null, verifiedAt: string|null}} */
        const userSession = {
          isVerified: false,
          birthYear: null,
          verifiedAt: null,
        };

        /** @type {Array<Object>} */
        let cachedDrinks = [];
        let currentSort = { key: 'drinkName', direction: 'asc' };
        const scriptRunner = typeof google !== 'undefined' && google.script && google.script.run ? google.script.run : null;

        // Element references -------------------------------------------------
        const ageGate = document.getElementById('ageGate');
        const ageForm = document.getElementById('ageForm');
        const ageError = document.getElementById('ageError');
        const ageOptions = document.querySelectorAll("input[name='ageConfirmation']");
        const appShell = document.getElementById('appShell');
        const homeButton = document.getElementById('homeButton');
        const homeView = document.getElementById('homeView');
        const createView = document.getElementById('createView');
        const searchView = document.getElementById('searchView');
        const newDrinkButton = document.getElementById('newDrinkButton');
        const searchButton = document.getElementById('searchButton');
        const createForm = document.getElementById('createForm');
        const generatorSelect = document.getElementById('generatorKey');
        const birthMonthSelect = document.getElementById('birthMonth');
        const birthDayInput = document.getElementById('birthDay');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const generateButton = document.getElementById('generateButton');
        const resultCard = document.getElementById('resultCard');
        const resultName = document.getElementById('resultName');
        const resultMeta = document.getElementById('resultMeta');
        const resultReason = document.getElementById('resultReason');
        const resultIngredients = document.getElementById('resultIngredients');
        const resultInstructions = document.getElementById('resultInstructions');
        const searchInput = document.getElementById('searchInput');
        const refreshButton = document.getElementById('refreshButton');
        const drinksTableBody = document.getElementById('drinksTableBody');
        const detailOverlay = document.getElementById('detailOverlay');
        const detailName = document.getElementById('detailName');
        const detailMeta = document.getElementById('detailMeta');
        const detailReason = document.getElementById('detailReason');
        const detailIngredients = document.getElementById('detailIngredients');
        const detailInstructions = document.getElementById('detailInstructions');
        const closeDetailButton = document.getElementById('closeDetailButton');
        const toast = document.getElementById('toast');
        const userSignature = document.getElementById('userSignature');
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const installDismissButton = document.getElementById('installDismissButton');
        const iosInstallBanner = document.getElementById('iosInstallBanner');
        const iosDismissButton = document.getElementById('iosDismissButton');
        const manifestLink = document.getElementById('pwaManifestLink');
        const appleTouchIconLink = document.getElementById('appleTouchIconLink');

        /**
         * Base manifest definition leveraged to generate a Blob-backed manifest
         * that incorporates the dynamically embedded icon payloads.
         * @type {!Object<string, *>}
         */
        const manifestDefinition = {
          name: 'Mythic Mixology Lab',
          short_name: 'Mixology',
          description: 'Craft cosmic cocktails with a native-feeling progressive web experience.',
          start_url: './',
          display: 'standalone',
          background_color: '#f5f5f7',
          theme_color: '#0071e3',
          lang: 'en',
          dir: 'ltr',
        };

        let generatedManifestUrl = '';
        if (window.AppIconAssets && typeof window.AppIconAssets.ensureManifest === 'function') {
          generatedManifestUrl = window.AppIconAssets.ensureManifest(manifestLink, manifestDefinition);
          window.AppIconAssets.applyIconToLink(appleTouchIconLink, 192);
        } else {
          console.warn('[PWA] Icon asset module unavailable; fallback manifest in use.');
        }

        window.addEventListener('unload', function () {
          if (generatedManifestUrl) {
            URL.revokeObjectURL(generatedManifestUrl);
            console.info('[PWA] Released generated manifest URL during unload.');
          }
        });

        /**
         * Provides a compact summary of values for diagnostic logging without
         * overwhelming international consoles.
         * @param {*} value Value to summarize.
         * @return {{type: string, keys?: string[], length?: number, sample?: string}}
         */
        function summarizeForLog(value) {
          if (value === null || value === undefined) {
            return { type: String(value) };
          }

          if (Array.isArray(value)) {
            return { type: 'array', length: value.length };
          }

          const valueType = typeof value;
          if (valueType === 'object') {
            try {
              return { type: 'object', keys: Object.keys(value) };
            } catch (error) {
              return { type: 'object', keys: ['<unavailable>'] };
            }
          }

          const sample = String(value);
          return {
            type: valueType,
            sample: sample.length > 120 ? sample.slice(0, 120) + '…' : sample,
          };
        }

        /**
         * Normalizes diverse Apps Script error shapes into a consistent object.
         * @param {*} error Raw error payload from failure handler.
         * @return {{message: string, detail: (string|null)}}
         */
        function normalizeServerError(error) {
          if (!error) {
            return { message: 'An unknown error occurred.', detail: null };
          }

          if (typeof error === 'string') {
            return { message: error, detail: null };
          }

          let message = 'An unexpected error was returned by the server.';
          if (typeof error.message === 'string' && error.message.trim()) {
            message = error.message.trim();
          } else if (typeof error.toString === 'function') {
            const converted = String(error.toString());
            if (converted && converted !== '[object Object]') {
              message = converted;
            }
          }

          let detail = null;
          if (error.stack) {
            detail = String(error.stack);
          } else if (error.details) {
            try {
              detail = typeof error.details === 'string' ? error.details : JSON.stringify(error.details);
            } catch (serializationError) {
              detail = 'Unable to serialize additional error details.';
            }
          }

          return { message: message, detail: detail };
        }

        /**
         * Populates month select options in an internationally friendly manner.
         */
        function populateMonths() {
          const monthNames = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December',
          ];
          birthMonthSelect.innerHTML = '<option value="">Select month</option>';
          monthNames.forEach(function (name, index) {
            const option = document.createElement('option');
            option.value = String(index + 1);
            option.textContent = name;
            birthMonthSelect.appendChild(option);
          });
        }

        /**
         * Invokes Apps Script backend methods with graceful fallbacks.
         * @param {string} methodName Method to invoke.
         * @param {*} payload Payload for the method.
         * @param {Function} onSuccess Success callback.
         * @param {Function} onFailure Failure callback.
         */
        function invokeServer(methodName, payload, onSuccess, onFailure) {
          if (!scriptRunner) {
            console.warn('[invokeServer] Apps Script runner unavailable; offline preview mode.');
            if (typeof onFailure === 'function') {
              onFailure(normalizeServerError(new Error('Apps Script interface unavailable in preview mode.')), null);
            }
            return;
          }

          console.info('[invokeServer] Dispatching method.', {
            methodName: methodName,
            payloadSummary: summarizeForLog(payload),
          });

          var startTime = Date.now();
          var runner = scriptRunner.withSuccessHandler(function (result) {
            var durationMs = Date.now() - startTime;
            console.info('[invokeServer] Method succeeded.', {
              methodName: methodName,
              durationMs: durationMs,
              resultSummary: summarizeForLog(result),
            });
            if (typeof onSuccess === 'function') {
              onSuccess(result);
            }
          });

          runner = runner.withFailureHandler(function (error) {
            var durationMs = Date.now() - startTime;
            var normalized = normalizeServerError(error);
            console.error('[invokeServer] Method failed.', {
              methodName: methodName,
              durationMs: durationMs,
              message: normalized.message,
            });
            if (normalized.detail) {
              console.debug('[invokeServer] Failure detail trace.', normalized.detail);
            }
            if (typeof onFailure === 'function') {
              onFailure(normalized, error);
            }
          });

          if (payload === undefined) {
            runner[methodName]();
          } else {
            runner[methodName](payload);
          }
        }

        /**
         * Displays a toast notification with verbose logging.
         * @param {string} message Message to display.
         */
        function showToast(message) {
          console.log('[Toast]', message);
          toast.textContent = message;
          toast.classList.add('active');
          setTimeout(function () {
            toast.classList.remove('active');
          }, 3800);
        }

        /**
         * Determines whether the experience is already operating in standalone mode.
         * @return {boolean} True when the browser reports a standalone display context.
         */
        function isStandaloneMode() {
          return (
            window.matchMedia('(display-mode: standalone)').matches === true ||
            window.navigator.standalone === true
          );
        }

        /**
         * Performs a lightweight detection for iOS devices.
         * @return {boolean} True when the user agent represents an iOS device.
         */
        function isIosDevice() {
          return /iphone|ipad|ipod/i.test(window.navigator.userAgent || '');
        }

        /**
         * Registers the progressive web app service worker to enable installation and caching.
         */
        function registerServiceWorker() {
          if (!('serviceWorker' in navigator)) {
            console.info('[PWA] Service workers are not supported in this browser.');
            return;
          }

          window.addEventListener('load', function () {
            navigator.serviceWorker
              .register('service-worker.js')
              .then(function (registration) {
                console.info('[PWA] Service worker registered.', { scope: registration.scope });
              })
              .catch(function (error) {
                console.error('[PWA] Service worker registration failed.', {
                  message: error && error.message ? error.message : 'Unknown error',
                });
              });
          });
        }

        /**
         * Configures install prompts for Android/desktop browsers and iOS guidance.
         */
        function initializeInstallPrompts() {
          if (
            !installBanner ||
            !installButton ||
            !installDismissButton ||
            !iosInstallBanner ||
            !iosDismissButton
          ) {
            console.warn('[PWA] Install controls are unavailable in the DOM.');
            return;
          }

          var smartDeviceRegex = /android|iphone|ipad|ipod|mobile/i;
          if (!smartDeviceRegex.test(window.navigator.userAgent || '')) {
            console.info('[PWA] Install prompts are presented only on smart devices.');
            return;
          }

          if (isStandaloneMode()) {
            console.info('[PWA] Experience already running in standalone mode.');
            return;
          }

          var deferredPrompt = null;

          if (isIosDevice()) {
            console.info('[PWA] Displaying iOS installation guidance.');
            iosInstallBanner.hidden = false;
            iosDismissButton.addEventListener('click', function () {
              iosInstallBanner.hidden = true;
              console.info('[PWA] iOS guidance dismissed.');
            });
          }

          window.addEventListener('beforeinstallprompt', function (event) {
            console.info('[PWA] beforeinstallprompt intercepted.', { platforms: event.platforms });
            event.preventDefault();
            deferredPrompt = event;
            installBanner.hidden = false;
          });

          installButton.addEventListener('click', function () {
            console.info('[PWA] Install button clicked.');
            if (!deferredPrompt) {
              console.warn('[PWA] No deferred prompt available for installation.');
              showToast('Install prompt not available. Use your browser menu to install.');
              return;
            }

            installBanner.hidden = true;
            deferredPrompt.prompt();
            deferredPrompt.userChoice
              .then(function (choice) {
                console.info('[PWA] Install choice recorded.', choice);
                if (!choice || choice.outcome !== 'accepted') {
                  showToast('Install cancelled. You can add it later from your browser menu.');
                }
              })
              .catch(function (error) {
                console.error('[PWA] Install prompt failed to resolve.', {
                  message: error && error.message ? error.message : 'Unknown error',
                });
              })
              .finally(function () {
                deferredPrompt = null;
              });
          });

          installDismissButton.addEventListener('click', function () {
            installBanner.hidden = true;
            console.info('[PWA] Install banner dismissed by the visitor.');
          });

          window.addEventListener('appinstalled', function () {
            console.info('[PWA] Application successfully installed.');
            installBanner.hidden = true;
            iosInstallBanner.hidden = true;
            showToast('Mythic Mixology Lab installed on your device.');
          });
        }

        /**
         * Switches the active view while maintaining the elegant navigation.
         * @param {HTMLElement} targetView Target section to reveal.
         */
        function switchView(targetView) {
          [homeView, createView, searchView].forEach(function (view) {
            view.classList.remove('active');
          });
          targetView.classList.add('active');
        }

        /**
         * Validates the age gate entry and unlocks the experience.
         * @param {Event} event Submission event.
         */
        function handleAgeGate(event) {
          event.preventDefault();
          var selected = null;
          ageOptions.forEach(function (option) {
            if (option.checked) {
              selected = option.value;
            }
          });

          if (!selected) {
            ageError.textContent = 'Please confirm that you are 21 or older to continue.';
            ageError.classList.add('active');
            console.warn('[AgeGate] Submission blocked due to missing confirmation.');
            return;
          }

          if (selected !== 'yes') {
            ageError.textContent = 'Access is limited to guests who are 21 years or older.';
            ageError.classList.add('active');
            console.warn('[AgeGate] Access denied because visitor is under 21.');
            return;
          }

          ageError.classList.remove('active');
          const verificationTimestamp = new Date();
          userSession.isVerified = true;
          // Default to the minimum eligible birth year to maintain deterministic
          // generator inputs while respecting the streamlined verification flow.
          userSession.birthYear = verificationTimestamp.getFullYear() - 21;
          userSession.verifiedAt = verificationTimestamp.toISOString();
          userSignature.textContent =
            '21+ Verified • ' + verificationTimestamp.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
          console.info('[AgeGate] Visitor affirmed they are 21+. Session unlocked.', {
            verifiedAt: userSession.verifiedAt,
          });
          ageGate.style.display = 'none';
          appShell.classList.add('active');
          switchView(homeView);
          showToast('Welcome to the Mythic Mixology Lab. Logging activated.');
        }

        /**
         * Removes invalid highlighting for corrected fields.
         * @param {HTMLElement} element Field element.
         */
        function clearInvalid(element) {
          element.classList.remove('field-invalid');
        }

        /**
         * Applies invalid styling and navigates to the field.
         * @param {HTMLElement} element Field element.
         */
        function markInvalid(element) {
          element.classList.add('field-invalid');
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.focus({ preventScroll: true });
        }

        /**
         * Collects and validates form data prior to generation.
         * @return {{generatorKey: string, birthMonth: number, birthDay: number, firstName: string, lastName: string}|null}
         */
        function collectFormData() {
          const fields = [generatorSelect, birthMonthSelect, birthDayInput, firstNameInput, lastNameInput];
          let firstInvalid = null;
          fields.forEach(function (field) {
            clearInvalid(field);
            if (!field.value) {
              firstInvalid = firstInvalid || field;
            }
          });

          const dayValue = Number(birthDayInput.value);
          if (!Number.isInteger(dayValue) || dayValue < 1 || dayValue > 31) {
            firstInvalid = firstInvalid || birthDayInput;
          }

          if (firstInvalid) {
            markInvalid(firstInvalid);
            return null;
          }

          if (!userSession.isVerified) {
            showToast('Age verification required before generation.');
            return null;
          }

          return {
            generatorKey: generatorSelect.value,
            birthMonth: Number(birthMonthSelect.value),
            birthDay: dayValue,
            // Ensure the generator receives a consistent birth year even if the
            // session falls back to the minimum eligible value.
            birthYear: userSession.birthYear || new Date().getFullYear() - 21,
            firstName: firstNameInput.value.trim(),
            lastName: lastNameInput.value.trim(),
          };
        }

        /**
         * Handles generator form submission by invoking the Apps Script backend.
         * @param {Event} event Submission event.
         */
        function handleGenerate(event) {
          event.preventDefault();
          const data = collectFormData();
          if (!data) {
            return;
          }

          generateButton.disabled = true;
          console.info('[handleGenerate] Validated form data ready for submission.', data);
          showToast('Contacting celestial servers...');

          invokeServer(
            'generateDrink',
            data,
            function (response) {
              console.log('[generateDrink success]', response);
              generateButton.disabled = false;
              renderResult(response);
              cachedDrinks.push(response);
              renderTable();
              showToast('Drink generated and stored successfully.');
            },
            function (normalizedError) {
              console.error('[generateDrink failure]', normalizedError);
              if (normalizedError.detail) {
                console.debug('[generateDrink failure detail]', normalizedError.detail);
              }
              generateButton.disabled = false;
              showToast('Generation failed: ' + normalizedError.message);
            }
          );
        }

        /**
         * Renders the generated drink card with aesthetic formatting.
         * @param {{drinkName: string, reason: string, ingredients: string[], instructions: string[], compatibility: string, generatorLabel: string}} payload
         */
        function renderResult(payload) {
          resultName.textContent = payload.drinkName;
          resultMeta.textContent = payload.compatibility + ' • ' + payload.generatorLabel;
          resultReason.textContent = payload.reason;
          resultIngredients.innerHTML = '';
          resultInstructions.innerHTML = '';

          payload.ingredients.forEach(function (ingredient) {
            const li = document.createElement('li');
            li.textContent = ingredient;
            resultIngredients.appendChild(li);
          });

          payload.instructions.forEach(function (instruction) {
            const li = document.createElement('li');
            li.textContent = instruction;
            resultInstructions.appendChild(li);
          });

          resultCard.classList.add('active');
        }

        /**
         * Fetches drinks from the backend and updates the table cache.
         */
        function fetchDrinks() {
          showToast('Refreshing archive from sheet...');
          invokeServer(
            'getStoredDrinks',
            undefined,
            function (records) {
              console.log('[getStoredDrinks success]', records);
              cachedDrinks = records;
              renderTable();
              showToast('Archive synchronized.');
            },
            function (normalizedError) {
              console.error('[getStoredDrinks failure]', normalizedError);
              if (normalizedError.detail) {
                console.debug('[getStoredDrinks failure detail]', normalizedError.detail);
              }
              showToast('Unable to retrieve drinks: ' + normalizedError.message);
            }
          );
        }

        /**
         * Applies search and sort to cached drinks and renders the table body.
         */
        function renderTable() {
          const filter = (searchInput.value || '').toLowerCase();
          const filtered = cachedDrinks.filter(function (drink) {
            const composite = [drink.drinkName, drink.generatorLabel, drink.reason, drink.compatibility]
              .join(' ')
              .toLowerCase();
            return composite.indexOf(filter) !== -1;
          });

          filtered.sort(function (a, b) {
            const key = currentSort.key;
            const direction = currentSort.direction === 'asc' ? 1 : -1;
            if (key === 'voteCount') {
              const numA = Number(a.voteCount || 0);
              const numB = Number(b.voteCount || 0);
              return numA === numB ? 0 : numA < numB ? -1 * direction : 1 * direction;
            }
            const valueA = (a[key] || '').toString().toLowerCase();
            const valueB = (b[key] || '').toString().toLowerCase();
            if (valueA < valueB) return -1 * direction;
            if (valueA > valueB) return 1 * direction;
            return 0;
          });

          drinksTableBody.innerHTML = '';
          if (!filtered.length) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 5;
            cell.textContent = 'No drinks found. Generate one to begin the dynasty!';
            row.appendChild(cell);
            drinksTableBody.appendChild(row);
            return;
          }

          filtered.forEach(function (drink) {
            const row = document.createElement('tr');
            row.innerHTML = [
              '<td>' + drink.drinkName + '</td>',
              '<td>' + drink.generatorLabel + '</td>',
              '<td>' + drink.compatibility + '</td>',
              '<td>' + (drink.voteCount || 0) + '</td>',
              '<td class="table-actions"></td>',
            ].join('');

            const actionsCell = row.querySelector('.table-actions');
            const detailBtn = document.createElement('button');
            detailBtn.type = 'button';
            detailBtn.className = 'ghost-button';
            detailBtn.textContent = 'View Details';
            detailBtn.addEventListener('click', function () {
              openDetail(drink);
            });

            const voteBtn = document.createElement('button');
            voteBtn.type = 'button';
            voteBtn.textContent = 'Vote';
            voteBtn.addEventListener('click', function () {
              handleVote(drink, voteBtn, row);
            });

            actionsCell.appendChild(detailBtn);
            actionsCell.appendChild(voteBtn);
            drinksTableBody.appendChild(row);
          });
        }

        /**
         * Opens the detail modal with comprehensive drink information.
         * @param {Object} drink Drink record.
         */
        function openDetail(drink) {
          detailName.textContent = drink.drinkName;
          detailMeta.textContent = drink.generatorLabel + ' • ' + drink.compatibility;
          detailReason.textContent = drink.reason;
          detailIngredients.innerHTML = '';
          detailInstructions.innerHTML = '';

          (drink.ingredients || []).forEach(function (ingredient) {
            const li = document.createElement('li');
            li.textContent = ingredient;
            detailIngredients.appendChild(li);
          });

          (drink.instructions || []).forEach(function (instruction) {
            const li = document.createElement('li');
            li.textContent = instruction;
            detailInstructions.appendChild(li);
          });

          detailOverlay.classList.add('active');
        }

        /**
         * Handles closing the detail modal.
         */
        function closeDetail() {
          detailOverlay.classList.remove('active');
        }

        /**
         * Sends a vote request to the backend and updates the UI.
         * @param {Object} drink Drink record being voted on.
         * @param {HTMLButtonElement} button The vote button.
         * @param {HTMLTableRowElement} row Table row for updating counts.
         */
        function handleVote(drink, button, row) {
          button.disabled = true;
          invokeServer(
            'registerVote',
            drink.drinkId,
            function (result) {
              console.log('[registerVote success]', result);
              button.disabled = false;
              drink.voteCount = result.voteCount;
              const voteCell = row.querySelector('td:nth-child(4)');
              if (voteCell) {
                voteCell.textContent = result.voteCount;
              }
              showToast('Vote tallied for ' + drink.drinkName + '.');
            },
            function (normalizedError) {
              console.error('[registerVote failure]', normalizedError);
              if (normalizedError.detail) {
                console.debug('[registerVote failure detail]', normalizedError.detail);
              }
              button.disabled = false;
              showToast('Unable to register vote: ' + normalizedError.message);
            }
          );
        }

        /**
         * Handles table header sorting interactions.
         * @param {MouseEvent} event Click event.
         */
        function handleSort(event) {
          const key = event.target.getAttribute('data-sort');
          if (!key) {
            return;
          }
          currentSort.direction = currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc';
          currentSort.key = key;
          renderTable();
        }

        // Event wiring -------------------------------------------------------
        ageForm.addEventListener('submit', handleAgeGate);
        homeButton.addEventListener('click', function () {
          switchView(homeView);
        });
        newDrinkButton.addEventListener('click', function () {
          switchView(createView);
        });
        searchButton.addEventListener('click', function () {
          switchView(searchView);
          fetchDrinks();
        });
        refreshButton.addEventListener('click', fetchDrinks);
        createForm.addEventListener('submit', handleGenerate);
        searchInput.addEventListener('input', renderTable);
        closeDetailButton.addEventListener('click', closeDetail);
        detailOverlay.addEventListener('click', function (event) {
          if (event.target === detailOverlay) {
            closeDetail();
          }
        });
        document.querySelectorAll('th button[data-sort]').forEach(function (button) {
          button.addEventListener('click', handleSort);
        });

        [generatorSelect, birthMonthSelect, birthDayInput, firstNameInput, lastNameInput].forEach(function (field) {
          field.addEventListener('input', function () {
            clearInvalid(field);
          });
        });

        registerServiceWorker();
        initializeInstallPrompts();
        populateMonths();
      })();
    </script>
  </body>
</html>
